name: Yasno Monitor for Kyiv 3.1

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache last status
        uses: actions/cache@v3
        with:
          path: status.txt
          key: yasno-status
          restore-keys: yasno-status

      - name: Check schedule and send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          QUEUE="3.1"
          DATE_NOW=$(date '+%Y-%m-%d')
          WEEKDAY=$(date '+%A')
          TIME_NOW=$(date '+%H:%M')
          OUTAGES=$(curl -s https://static.yasno.ua/kyiv/outages)
          QUEUE_STATUS=$(echo "$OUTAGES" | jq -c --arg q "$QUEUE" '.[$q]')
          [ -z "$QUEUE_STATUS" ] && echo "No data for queue $QUEUE, exiting." && exit 0

          STATUS_TODAY=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date | startswith("'"$DATE_NOW"'")) | .status ] | join(",")')
          MESSAGE=""
          ALERT_HASH=""
          if echo "$STATUS_TODAY" | grep -q off; then
            FIRST_OFF=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date | startswith("'"$DATE_NOW"'") and .status=="off")][0].date')
            FIRST_ON=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date > "'"$FIRST_OFF"'") and .status=="on"][0].date')
            MESSAGE="ðŸª« Ð’Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ÑÐ²Ñ–Ñ‚Ð»Ð°: $QUEUE
ÐŸÐ¾Ñ‡Ð°Ñ‚Ð¾Ðº: $FIRST_OFF
Ð’Ñ–Ð´Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ: $FIRST_ON
Ð”Ð°Ñ‚Ð°: $DATE_NOW, $WEEKDAY"
            ALERT_HASH="off-$FIRST_OFF-$FIRST_ON"
          elif echo "$STATUS_TODAY" | grep -q maybe; then
            FIRST_MAYBE=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date | startswith("'"$DATE_NOW"'") and .status=="maybe")][0].date')
            MESSAGE="âš ï¸ ÐœÐ¾Ð¶Ð»Ð¸Ð²Ðµ Ð²Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ (Ð³Ñ€ÑƒÐ¿Ð° $QUEUE) $FIRST_MAYBE $DATE_NOW, $WEEKDAY"
            ALERT_HASH="maybe-$FIRST_MAYBE"
          else
            MESSAGE="âœ… Ð¡Ð²Ñ–Ñ‚Ð»Ð¾ Ð±ÑƒÐ´Ðµ Ð²ÐµÑÑŒ Ð´ÐµÐ½ÑŒ (Ð³Ñ€ÑƒÐ¿Ð° $QUEUE) $DATE_NOW, $WEEKDAY"
            ALERT_HASH="on"
          fi

          PREV=""
          [ -f status.txt ] && PREV=$(cat status.txt)
          if [ "$PREV" != "$ALERT_HASH" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage"               -d chat_id="${CHAT_ID}"               -d text="$MESSAGE"
            echo "$ALERT_HASH" > status.txt
          else
            echo "No change, not sending"
          fi

      - name: Complete
        run: echo "Yasno Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐµÐ½Ð¾: $(date '+%H:%M %d.%m.%Y')"
