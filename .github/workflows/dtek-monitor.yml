name: Yasno Monitor for Kyiv 3.2

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache last status
        uses: actions/cache@v3
        with:
          path: status.txt
          key: yasno-status-v2
          restore-keys: yasno-status-v2

      - name: Check schedule and send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          QUEUE="3.2"
          API_URL="https://app.yasno.ua/api/blackout-service/public/shutdowns/regions/25/dsos/902/planned-outages"
          WEEKDAY=$(date '+%A')

          min_to_hhmm() {
            MINUTES=$1
            HH=$((MINUTES / 60))
            MM=$((MINUTES % 60))
            printf "%02d:%02d" $HH $MM
          }
          export -f min_to_hhmm

          echo "Fetching data from NEW Yasno API for queue $QUEUE..."
          OUTAGES=$(curl -s "$API_URL")

          if [ -z "$OUTAGES" ] || echo "$OUTAGES" | grep -q "error"; then
            echo "::error:: Failed to fetch data or API returned error."
            exit 1
          fi

          QUEUE_TODAY=$(echo "$OUTAGES" | jq -c --arg q "$QUEUE" '.[$q].today')

          if [ -z "$QUEUE_TODAY" ] || [ "$QUEUE_TODAY" == "null" ]; then
            echo "::warning:: No 'today' data found for queue $QUEUE."
            MESSAGE="<b>ü§∑‚Äç‚ôÇÔ∏è –ü–æ–º–∏–ª–∫–∞: –ì—Ä—É–ø–∞ $QUEUE ($WEEKDAY)</b>\n\n–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ YASNO."
            ALERT_HASH="error-$(date +%H)"
          else
            DEFINITE_SLOTS=$(echo "$QUEUE_TODAY" | jq -r '.slots[] | select(.type == "Definite") | "\(.start) \(.end)"')
            PROBABLE_SLOTS=$(echo "$QUEUE_TODAY" | jq -r '.slots[] | select(.type == "Probable") | "\(.start) \(.end)"')

            MESSAGE=""
            ALERT_HASH=""

            if [ -n "$DEFINITE_SLOTS" ]; then
              MESSAGE="<b>ü™´ –ü–ª–∞–Ω–æ–≤—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: –ì—Ä—É–ø–∞ $QUEUE ($WEEKDAY)</b>\n\n<b>–ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω—ñ —Å–ª–æ—Ç–∏:</b>\n"
              ALERT_HASH="off"
              while IFS= read -r SLOT; do
                START_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f1))
                END_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f2))
                MESSAGE+="‚Ä¢ <code>$START_TIME - $END_TIME</code>\n"
                ALERT_HASH+="-$START_TIME-$END_TIME"
              done <<< "$DEFINITE_SLOTS"
            
            elif [ -n "$PROBABLE_SLOTS" ]; then
              MESSAGE="<b>‚ö†Ô∏è –ú–æ–∂–ª–∏–≤—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: $QUEUE ($WEEKDAY)</b>\n\n<b>–ô–º–æ–≤—ñ—Ä–Ω—ñ —Å–ª–æ—Ç–∏:</b>\n"
              ALERT_HASH="maybe"
              while IFS= read -r SLOT; do
                START_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f1))
                END_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f2))
                MESSAGE+="‚Ä¢ <code>$START_TIME - $END_TIME</code>\n"
                ALERT_HASH+="-$START_TIME-$END_TIME"
              done <<< "$PROBABLE_SLOTS"

            else
              MESSAGE="<b>‚úÖ –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–µ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ: –ì—Ä—É–ø–∞ $QUEUE ($WEEKDAY)</b>\n\n–ó–∞ –≥—Ä–∞—Ñ—ñ–∫–æ–º, –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –Ω–µ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ."
              ALERT_HASH="on"
            fi
          fi

          echo -e "Generated Message:\n$MESSAGE"
          echo "Generated Hash: $ALERT_HASH"

          PREV=""
          [ -f status.txt ] && PREV=$(cat status.txt)

          if [ "$PREV" != "$ALERT_HASH" ]; then
            echo "Status changed. Sending notification..."
            PAYLOAD=$(jq -n --arg chat_id "$CHAT_ID" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -H 'Content-Type: application/json' \
              -d "$PAYLOAD"
              
            echo "$ALERT_HASH" > status.txt
            echo "New hash saved."
          else
            echo "No change, not sending"
          fi
