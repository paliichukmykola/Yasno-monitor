name: Yasno Monitor for Kyiv 3.1

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache last status
        uses: actions/cache@v3
        with:
          path: status.txt
          key: yasno-status
          restore-keys: yasno-status

      - name: Check schedule and send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "--- Starting Yasno Check ---"
          QUEUE="3.1"
          DATE_NOW=$(date '+%Y-%m-%d')
          WEEKDAY=$(date '+%A')
          
          echo "Date: $DATE_NOW, Queue: $QUEUE"
          
          echo "Fetching data from Yasno..."
          OUTAGES=$(curl -s https://static.yasno.ua/kyiv/outages)
          
          if [ -z "$OUTAGES" ]; then
            echo "::error:: Failed to fetch data. OUTAGES variable is empty."
            exit 1
          fi
          
          echo "Data fetched (first 300 chars): ${OUTAGES:0:300}..."
          
          echo "Querying JSON for queue $QUEUE..."
          QUEUE_STATUS=$(echo "$OUTAGES" | jq -c --arg q "$QUEUE" '.[$q]')
          
          if [ -z "$QUEUE_STATUS" ] || [ "$QUEUE_STATUS" == "null" ]; then
            echo "::warning:: No data found for queue $QUEUE. Exiting gracefully."
            echo "Raw QUEUE_STATUS was: $QUEUE_STATUS"
            exit 0
          fi
          
          echo "Queue $QUEUE status: $QUEUE_STATUS"
          
          STATUS_TODAY=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date | startswith("'"$DATE_NOW"'")) | .status ] | join(",")')
          echo "Status for today: $STATUS_TODAY"
          
          MESSAGE=""
          ALERT_HASH=""
          
          if echo "$STATUS_TODAY" | grep -q off; then
            echo "Found 'off' status."
            FIRST_OFF=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date | startswith("'"$DATE_NOW"'") and .status=="off")][0].date')
            FIRST_ON=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date > "'"$FIRST_OFF"'") and .status=="on"][0].date')
            MESSAGE="ðŸª« Ð’Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ÑÐ²Ñ–Ñ‚Ð»Ð°: $QUEUE\nÐŸÐ¾Ñ‡Ð°Ñ‚Ð¾Ðº: $FIRST_OFF\nÐ’Ñ–Ð´Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ: $FIRST_ON\nÐ”Ð°Ñ‚Ð°: $DATE_NOW, $WEEKDAY"
            ALERT_HASH="off-$FIRST_OFF-$FIRST_ON"
          
          elif echo "$STATUS_TODAY" | grep -q maybe; then
            echo "Found 'maybe' status."
            FIRST_MAYBE=$(echo "$QUEUE_STATUS" | jq -r '[ .[] | select(.date | startswith("'"$DATE_NOW"'") and .status=="maybe")][0].date')
            MESSAGE="âš ï¸ ÐœÐ¾Ð¶Ð»Ð¸Ð²Ðµ Ð²Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ (Ð³Ñ€ÑƒÐ¿Ð° $QUEUE) $FIRST_MAYBE $DATE_NOW, $WEEKDAY"
            ALERT_HASH="maybe-$FIRST_MAYBE"
          
          else
            echo "Found 'on' status."
            MESSAGE="âœ… Ð¡Ð²Ñ–Ñ‚Ð»Ð¾ Ð±ÑƒÐ´Ðµ Ð²ÐµÑÑŒ Ð´ÐµÐ½ÑŒ (Ð³Ñ€ÑƒÐ¿Ð° $QUEUE) $DATE_NOW, $WEEKDAY"
            ALERT_HASH="on"
          fi
          
          echo "Generated Message: $MESSAGE"
          echo "Generated Hash: $ALERT_HASH"

          PREV=""
          [ -f status.txt ] && PREV=$(cat status.txt)
          echo "Previous Hash: $PREV"

          if [ "$PREV" != "$ALERT_HASH" ]; then
            echo "Status changed. Sending notification..."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="$MESSAGE"
            echo "$ALERT_HASH" > status.txt
            echo "New hash saved."
          else
            echo "No change, not sending"
          fi

      - name: Complete
        run: echo "Yasno check complete: $(date '+%H:%M %d.%m.%Y')"
