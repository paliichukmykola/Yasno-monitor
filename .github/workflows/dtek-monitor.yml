name: Yasno Monitor for Kyiv 3.2

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cache last status
        uses: actions/cache@v3
        with:
          path: status.txt
          key: yasno-status-v2 # –ó–º—ñ–Ω–∏–≤ –∫–ª—é—á –∫–µ—à—É –Ω–∞ v2
          restore-keys: yasno-status-v2

      - name: Check schedule and send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ---
          QUEUE="3.2" # –í–∞—à–∞ –≥—Ä—É–ø–∞
          API_URL="https://app.yasno.ua/api/blackout-service/public/shutdowns/regions/25/dsos/902/planned-outages"
          WEEKDAY=$(date '+%A')

          # --- –§—É–Ω–∫—Ü—ñ—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —Ö–≤–∏–ª–∏–Ω –≤ HH:MM ---
          min_to_hhmm() {
            MINUTES=$1
            HH=$((MINUTES / 60))
            MM=$((MINUTES % 60))
            printf "%02d:%02d" $HH $MM
          }
          export -f min_to_hhmm # –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è sub-shell

          # --- 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
          echo "Fetching data from NEW Yasno API for queue $QUEUE..."
          OUTAGES=$(curl -s "$API_URL")

          if [ -z "$OUTAGES" ] || echo "$OUTAGES" | grep -q "error"; then
            echo "::error:: Failed to fetch data or API returned error."
            exit 1
          fi

          # --- 2. –û–±—Ä–æ–±–∫–∞ JSON ---
          # –û—Ç—Ä–∏–º—É—î–º–æ –æ–±'—î–∫—Ç .today –¥–ª—è –Ω–∞—à–æ—ó –≥—Ä—É–ø–∏
          QUEUE_TODAY=$(echo "$OUTAGES" | jq -c --arg q "$QUEUE" '.[$q].today')

          if [ -z "$QUEUE_TODAY" ] || [ "$QUEUE_TODAY" == "null" ]; then
            echo "::warning:: No 'today' data found for queue $QUEUE."
            MESSAGE="ü§∑‚Äç‚ôÇÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –≥—Ä—É–ø–∏ $QUEUE ($WEEKDAY)"
            ALERT_HASH="error-$(date +%H)"
          else
            # –®—É–∫–∞—î–º–æ –ì–ê–†–ê–ù–¢–û–í–ê–ù–Ü –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
            DEFINITE_SLOTS=$(echo "$QUEUE_TODAY" | jq -r '.slots[] | select(.type == "Definite") | "\(.start) \(.end)"')
            
            # –®—É–∫–∞—î–º–æ –ú–û–ñ–õ–ò–í–Ü –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ —Ç–∏–ø "Probable")
            PROBABLE_SLOTS=$(echo "$QUEUE_TODAY" | jq -r '.slots[] | select(.type == "Probable") | "\(.start) \(.end)"')

            MESSAGE=""
            ALERT_HASH=""

            if [ -n "$DEFINITE_SLOTS" ]; then
              MESSAGE="ü™´ –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: $QUEUE ($WEEKDAY)\n"
              ALERT_HASH="off"
              while IFS= read -r SLOT; do
                START_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f1))
                END_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f2))
                MESSAGE+="  ‚Ä¢ $START_TIME - $END_TIME\n"
                ALERT_HASH+="-$START_TIME-$END_TIME"
              done <<< "$DEFINITE_SLOTS"
            
            elif [ -n "$PROBABLE_SLOTS" ]; then
              MESSAGE="‚ö†Ô∏è –ú–æ–∂–ª–∏–≤—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: $QUEUE ($WEEKDAY)\n"
              ALERT_HASH="maybe"
              while IFS= read -r SLOT; do
                START_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f1))
                END_TIME=$(min_to_hhmm $(echo $SLOT | cut -d' ' -f2))
                MESSAGE+="  ‚Ä¢ $START_TIME - $END_TIME\n"
                ALERT_HASH+="-$START_TIME-$END_TIME"
              done <<< "$PROBABLE_SLOTS"

            else
              MESSAGE="‚úÖ –°–≤—ñ—Ç–ª–æ –±—É–¥–µ –≤–µ—Å—å –¥–µ–Ω—å (–≥—Ä—É–ø–∞ $QUEUE) $WEEKDAY"
              ALERT_HASH="on"
            fi
          fi

          # --- 3. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—è–∫—â–æ —î –∑–º—ñ–Ω–∏) ---
          echo -e "Generated Message:\n$MESSAGE"
          echo "Generated Hash: $ALERT_HASH"

          PREV=""
          [ -f status.txt ] && PREV=$(cat status.txt)

          if [ "$PREV" != "$ALERT_HASH" ]; then
            echo "Status changed. Sending notification..."
            # –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ MESSAGE –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ –≤ curl
            PAYLOAD=$(jq -n --arg chat_id "$CHAT_ID" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text}')
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -H 'Content-Type: application/json' \
              -d "$PAYLOAD"
              
            echo "$ALERT_HASH" > status.txt
            echo "New hash saved."
          else
            echo "No change, not sending"
          fi

      - name: Complete
        # –¶–µ–π –∫—Ä–æ–∫ —Ç–µ–ø–µ—Ä –º–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø
        run: echo "Yasno check complete: $(date '+%H:%M %d.%m.%Y')"
