name: Yasno Outages Monitor for Kyiv 3.1

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Check Yasno schedule and send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # Параметри для групи 3.1 Київ
          CITY="kyiv"
          GROUP="3.1"

          # Отримати дані з API Yasno
          echo "Fetching data from Yasno API..."
          RESPONSE=$(curl -s "https://api.yasno.com.ua/api/v1/pages/home/schedule-turn-off-electricity"             -H "Accept: application/json, text/html"             -H "Cache-Control: no-cache")

          # Перевірити, чи отримані дані
          if [ -z "$RESPONSE" ]; then
            echo "Failed to fetch data from API"
            exit 1
          fi

          # Витягти дані для сьогодні
          TODAY=$(date '+%Y-%m-%d')
          echo "Processing data for $TODAY (Group $GROUP)"

          # Парсити JSON та знайти статус для нашої групи
          STATUS=$(echo "$RESPONSE" | jq -r ".components[0].dailySchedule.kyiv.today.groups | .["$GROUP"] // empty" 2>/dev/null)

          if [ -z "$STATUS" ]; then
            echo "No status found for group $GROUP"
            # Відправити інформаційне повідомлення
            MESSAGE="[INFO] Не вдалось отримати дані для групи $GROUP. API може тимчасово недоступний."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="$MESSAGE" > /dev/null
            exit 0
          fi

          # Парсити статуси блекаутів
          OUTAGES=$(echo "$STATUS" | jq -r '.[] | select(.type=="DEFINITE_OUTAGE" or .type=="POSSIBLE_OUTAGE") | "\(.start)-\(.end)"' 2>/dev/null)

          if [ -z "$OUTAGES" ]; then
            MESSAGE="✅ [$(date '+%H:%M')] Група $GROUP: Світло буде весь день"
          else
            OUTAGE_TIME=$(echo "$OUTAGES" | head -1)
            MESSAGE="⚠️ [$(date '+%H:%M')] Група $GROUP: Відключення $OUTAGE_TIME"
          fi

          # Перевірити кеш останнього повідомлення
          STATUS_FILE="last_status_$GROUP.txt"

          if [ -f "$STATUS_FILE" ]; then
            PREV_STATUS=$(cat "$STATUS_FILE")
            if [ "$MESSAGE" = "$PREV_STATUS" ]; then
              echo "Status unchanged, not sending notification"
              exit 0
            fi
          fi

          # Відправити повідомлення в Telegram
          echo "Sending message: $MESSAGE"
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="$MESSAGE")

          # Зберегти статус
          echo "$MESSAGE" > "$STATUS_FILE"

          # Перевірити успіх
          if echo "$RESPONSE" | jq -e '.ok' > /dev/null 2>&1; then
            echo "Message sent successfully"
          else
            echo "Failed to send message: $RESPONSE"
            exit 1
          fi
